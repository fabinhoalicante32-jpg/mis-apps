<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parking</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#222222" />

  <style>
    html, body { height: 100%; margin: 0; padding: 0; background:#fff; }
    #appFrame{
      width:100%;
      height:100%;
      border:0;
      display:block;
    }
  </style>
</head>

<body>
  <!-- Tu app real (no tocamos parking.html) -->
  <iframe id="appFrame" src="../parking.html"></iframe>

  <script>
    // 1) Registrar service worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    }

    // 2) Pedir permiso de notificaciones (solo si hace falta)
    async function asegurarPermisoNoti() {
      if (!("Notification" in window)) return false;
      if (Notification.permission === "granted") return true;
      if (Notification.permission === "denied") return false;

      const p = await Notification.requestPermission();
      return p === "granted";
    }

    // 3) Mostrar notificación (sin push, solo “local” al guardar)
    // ✅ CAMBIO: mandamos lat/lng al service worker (NO url)
    async function notificarBuscarCoche(lat, lng) {
      const ok = await asegurarPermisoNoti();
      if (!ok) return;

      const reg = await navigator.serviceWorker.ready;

      await reg.showNotification("Buscar coche", {
        body: "Toca para abrir Google Maps",
        tag: "buscar-coche",
        renotify: true,
        data: { lat, lng } // ✅ esto lo usa el service-worker.js al hacer click
      });
    }

    // 4) Leer coords desde el contenido de tu app (estadoBox suele mostrar "Coords 38.xxx, -0.xxx")
    function leerCoordsDesdeIframe(iframe) {
      try {
        const doc = iframe.contentDocument;
        if (!doc) return null;

        const box = doc.getElementById("estadoBox");
        if (!box) return null;

        const txt = (box.textContent || "").trim();
        // Busca algo tipo: 38.366898, -0.493942
        const m = txt.match(/(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)/);
        if (!m) return null;

        const lat = parseFloat(m[1]);
        const lng = parseFloat(m[2]);
        if (Number.isNaN(lat) || Number.isNaN(lng)) return null;

        return { lat, lng };
      } catch (e) {
        return null;
      }
    }

    // 5) Intentar “forzar” guardar aunque haya una ubicación previa
    // ✅ NO tocamos parking.html: probamos funciones comunes si existen
    function intentarBorrarAntesDeGuardar(w) {
      try {
        if (typeof w.borrarParking === "function") w.borrarParking();
        if (typeof w.borrarUbicacion === "function") w.borrarUbicacion();
        if (typeof w.limpiarParking === "function") w.limpiarParking();
        if (typeof w.resetParking === "function") w.resetParking();
      } catch (e) {}
    }

    // 6) Enganchar (sin tocar parking.html): “envolvemos” la función guardarParking del iframe
    function engancharGuardar(iframe) {
      try {
        const w = iframe.contentWindow;
        if (!w || typeof w.guardarParking !== "function") return;

        if (w.__fabioHooked) return; // evitar enganchar 2 veces
        w.__fabioHooked = true;

        const original = w.guardarParking.bind(w);

        w.guardarParking = async function() {
          // ✅ primero intentamos borrar si existe algo (para evitar “ya hay una ubicación”)
          intentarBorrarAntesDeGuardar(w);

          // ejecuta lo de siempre (tu app guarda ubicación)
          const r = await original();

          // espera un pelín a que actualice estadoBox
          setTimeout(() => {
            const coords = leerCoordsDesdeIframe(iframe);
            if (coords) {
              notificarBuscarCoche(coords.lat, coords.lng);
            }
          }, 300);

          return r;
        };
      } catch (e) {}
    }

    // 7) Atajo “Aparcar”: si abres la PWA con #aparcar, auto-guarda
    function autoAparcarSiToca(iframe) {
      const shouldPark = (location.hash === "#aparcar");
      if (!shouldPark) return;

      try {
        const w = iframe.contentWindow;
        if (w && typeof w.guardarParking === "function") {
          w.guardarParking();
        }
      } catch (e) {}
    }

    const iframe = document.getElementById("appFrame");

    iframe.addEventListener("load", () => {
      engancharGuardar(iframe);
      autoAparcarSiToca(iframe);
    });
  </script>
</body>
</html>
