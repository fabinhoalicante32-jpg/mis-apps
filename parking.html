<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Parking</title>
<style>
  body{
    font-family: Arial, sans-serif;
    background:#f4f6f9;
    margin:0;
    padding:12px;
  }
  h1{
    text-align:center;
    font-size:22px;
    margin:6px 0 4px 0;
  }
  .date-top{
    text-align:center;
    font-size:13px;
    color:#777;
    margin-bottom:12px;
  }
  .card{
    background:#fff;
    padding:14px;
    border-radius:14px;
    margin-bottom:14px;
    box-shadow:0 4px 12px rgba(0,0,0,0.05);
  }
  button, input{
    width:100%;
    box-sizing:border-box;
    padding:10px;
    margin:6px 0;
    border-radius:10px;
    border:1px solid #ddd;
    font-size:14px;
  }
  button{
    background:#004481;
    color:#fff;
    border:none;
    font-weight:bold;
    cursor:pointer;
  }
  button:disabled{
    opacity:0.6;
    cursor:not-allowed;
  }
  .btn-row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .btn-row button{
    width:auto;
    flex:1 1 160px;
    padding:10px 8px;
  }
  .danger{ background:#b00020; }
  .soft{
    background:#e6f0fa;
    color:#0b2a55;
    border:1px solid rgba(0,0,0,0.08);
  }
  .big{
    padding:14px;
    font-size:16px;
    border-radius:14px;
  }
  .line{
    display:flex;
    justify-content:space-between;
    gap:10px;
    padding:7px 0;
    border-bottom:1px solid #f0f0f0;
    font-size:14px;
  }
  .line:last-child{border-bottom:none;}
  .muted{color:#666;}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  .small{ font-size:13px; color:#666; }
</style>
</head>
<body>

<h1>Parking</h1>
<div class="date-top" id="fechaHoy"></div>

<div class="card">
  <strong>Mi coche</strong>

  <button class="big" id="btnGuardar" onclick="guardarParking()">üìç Guardar d√≥nde aparqu√©</button>

  <div class="btn-row">
    <button id="btnAndando" class="soft" onclick="abrirRutaAndando()" disabled>üö∂ Ir andando al coche</button>
    <button id="btnVer" class="soft" onclick="verUbicacionCoche()" disabled>üìå Ver d√≥nde est√° mi coche</button>
  </div>

  <div style="margin-top:10px" id="estadoBox" class="small muted">
    Sin ubicaci√≥n guardada todav√≠a.
  </div>

  <div class="btn-row" style="margin-top:10px">
    <button id="btnCopiar" onclick="copiarCoords()" disabled>Copiar coordenadas</button>
    <button id="btnBorrar" class="danger" onclick="borrarParking()" disabled>Borrar ubicaci√≥n</button>
  </div>
</div>

<div class="card">
  <strong>Seguridad de datos</strong>
  <button onclick="hacerBackup()">Hacer copia de seguridad</button>
  <input type="file" id="restaurarInput" style="display:none" onchange="restaurarBackup(event)">
  <button onclick="document.getElementById('restaurarInput').click()">Restaurar copia</button>
  <div class="small muted" style="margin-top:8px;">
    La copia guarda solo esta app (ubicaci√≥n + fecha + precisi√≥n).
  </div>
</div>

<script>
const LS = { PARK: "park1_location" };

document.getElementById("fechaHoy").textContent = new Date().toLocaleDateString("es-ES");
let park = null; // {lat, lon, acc, ts}

function safeNum(n){
  const x = parseFloat(n);
  return isNaN(x) ? 0 : x;
}
function pad2(n){ return String(n).padStart(2,"0"); }
function formatDT(ts){
  const d = new Date(ts);
  return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function setEnabled(has){
  document.getElementById("btnAndando").disabled = !has;
  document.getElementById("btnVer").disabled = !has;
  document.getElementById("btnBorrar").disabled = !has;
  document.getElementById("btnCopiar").disabled = !has;
}

function render(){
  const box = document.getElementById("estadoBox");

  if(!park){
    box.innerHTML = "Sin ubicaci√≥n guardada todav√≠a.";
    setEnabled(false);
    return;
  }

  const acc = safeNum(park.acc);
  const when = park.ts ? formatDT(park.ts) : "‚Äî";

  box.innerHTML = `
    <div class="line"><span class="muted">Guardado</span><span><b>${when}</b></span></div>
    <div class="line"><span class="muted">Precisi√≥n</span><span>${acc ? (Math.round(acc) + " m") : "‚Äî"}</span></div>
    <div class="line"><span class="muted">Coords</span><span class="mono">${park.lat.toFixed(6)}, ${park.lon.toFixed(6)}</span></div>
  `;

  setEnabled(true);
}

function guardarParking(opts = {}){
  const { silent=false, overwrite=false } = opts;

  if(!navigator.geolocation){
    if(!silent) alert("Tu navegador no soporta GPS (geolocalizaci√≥n).");
    return;
  }

  // si ya hay una ubicaci√≥n y no quieres sobreescribir (modo rutina auto), salimos
  if(park && !overwrite){
    if(!silent) alert("Ya hay una ubicaci√≥n guardada. Si quieres cambiarla, pulsa Guardar.");
    return;
  }

  const btn = document.getElementById("btnGuardar");
  btn.disabled = true;
  btn.textContent = "Guardando ubicaci√≥n...";

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy;
      const ts = Date.now();

      park = {lat, lon, acc, ts};
      localStorage.setItem(LS.PARK, JSON.stringify(park));

      btn.disabled = false;
      btn.textContent = "üìç Guardar d√≥nde aparqu√©";

      try{ navigator.vibrate && navigator.vibrate(60); }catch(e){}

      render();
      if(!silent) alert("Ubicaci√≥n guardada ‚úÖ");
    },
    (err) => {
      btn.disabled = false;
      btn.textContent = "üìç Guardar d√≥nde aparqu√©";

      let msg = "No se pudo obtener la ubicaci√≥n.";
      if(err && err.code === 1) msg = "Permiso denegado. Activa la ubicaci√≥n para Chrome y vuelve a probar.";
      if(err && err.code === 2) msg = "Ubicaci√≥n no disponible. Prueba en un sitio con mejor cobertura GPS.";
      if(err && err.code === 3) msg = "Se agot√≥ el tiempo. Vuelve a intentar.";

      if(!silent) alert(msg);
    },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
  );
}

function abrirRutaAndando(){
  if(!park) return;
  const dest = `${park.lat},${park.lon}`;
  const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}&travelmode=walking`;
  window.location.href = `google.navigation:q=${park.lat},${park.lon}&mode=w`;
}

// üìå Ver pin del coche en Maps (sin ruta)
function verUbicacionCoche(){
  if(!park) return;
  const q = `${park.lat},${park.lon}`;
  const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
  window.location.href = `geo:${park.lat},${park.lon}?q=${park.lat},${park.lon}(Mi+Coche)`;
}

async function copiarCoords(){
  if(!park) return;
  const txt = `${park.lat.toFixed(6)}, ${park.lon.toFixed(6)}`;
  try{
    await navigator.clipboard.writeText(txt);
    alert("Coordenadas copiadas ‚úÖ");
  }catch(e){
    const tmp = document.createElement("textarea");
    tmp.value = txt;
    document.body.appendChild(tmp);
    tmp.select();
    document.execCommand("copy");
    tmp.remove();
    alert("Coordenadas copiadas ‚úÖ");
  }
}

function borrarParking(){
  if(!park) return;
  if(!confirm("¬øBorrar la ubicaci√≥n guardada?")) return;

  park = null;
  localStorage.removeItem(LS.PARK);
  render();
  alert("Ubicaci√≥n borrada");
}

function hacerBackup(){
  const data = { park1_location: park };
  const blob = new Blob([JSON.stringify(data)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "parking_backup.json";
  a.click();
  URL.revokeObjectURL(url);
  alert("Copia de seguridad creada");
}

function restaurarBackup(event){
  const file = event.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(e){
    try{
      const data = JSON.parse(e.target.result);
      const p = data.park1_location;

      if(p && typeof p.lat === "number" && typeof p.lon === "number"){
        park = { lat: p.lat, lon: p.lon, acc: safeNum(p.acc), ts: p.ts || Date.now() };
        localStorage.setItem(LS.PARK, JSON.stringify(park));
        render();
        alert("Copia restaurada correctamente ‚úÖ");
      }else{
        alert("Archivo v√°lido, pero no contiene ubicaci√≥n.");
      }
    }catch(err){
      alert("Archivo no v√°lido");
    }finally{
      event.target.value = "";
    }
  };
  reader.readAsText(file);
}

function getParams(){
  const p = new URLSearchParams(window.location.search);
  return {
    auto: p.get("auto") === "1",
    go: p.get("go") === "1"
  };
}

(function init(){
  try{
    const saved = JSON.parse(localStorage.getItem(LS.PARK));
    if(saved && typeof saved.lat === "number" && typeof saved.lon === "number"){
      park = saved;
    }
  }catch(e){}

  render();

  // ‚úÖ par√°metros para tus rutinas Samsung
  const params = getParams();

  // auto=1 -> guarda SOLO si no hay ubicaci√≥n guardada (no pisa la anterior)
  if(params.auto){
    guardarParking({ silent:true, overwrite:false });
  }

  // go=1 -> abre Maps directo al pin del coche
  if(params.go){
    if(park) verUbicacionCoche();
    else alert("No hay ubicaci√≥n guardada todav√≠a.");
  }
})();
</script>

</body>
</html>
