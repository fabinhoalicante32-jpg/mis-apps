<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Parking</title>
<style>
  :root{
    /* Tema A (CLARO gris premium) */
    --bg: #f3f4f6;
    --card: #ffffff;
    --text: #111827;
    --muted: #6b7280;
    --border: rgba(17,24,39,0.10);
    --shadow: 0 6px 18px rgba(0,0,0,0.06);

    --btn: #374151;           /* principal */
    --btnText: #ffffff;

    --btnSoftBg: #f3f4f6;     /* secundarios */
    --btnSoftText: #111827;
    --btnSoftBorder: rgba(17,24,39,0.12);

    --danger: #b00020;

    --line: rgba(17,24,39,0.08);
    --chipBg: rgba(17,24,39,0.04);

    --radiusCard: 16px;
    --radiusBtn: 12px;
  }

  body.dark{
    /* Tema B (OSCURO dark steel) */
    --bg: #0b1220;
    --card: #111a2e;
    --text: #e5e7eb;
    --muted: #9ca3af;
    --border: rgba(255,255,255,0.10);
    --shadow: 0 10px 22px rgba(0,0,0,0.35);

    --btn: #e5e7eb;
    --btnText: #0b1220;

    --btnSoftBg: rgba(255,255,255,0.06);
    --btnSoftText: #e5e7eb;
    --btnSoftBorder: rgba(255,255,255,0.14);

    --danger: #ff4d6d;

    --line: rgba(255,255,255,0.10);
    --chipBg: rgba(255,255,255,0.06);
  }

  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    margin:0;
    padding:14px;
  }

  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin:6px 0 12px 0;
  }

  h1{
    font-size:22px;
    margin:0;
    letter-spacing:0.2px;
  }

  .date-top{
    font-size:13px;
    color: var(--muted);
    margin:4px 0 0 0;
  }

  .theme-btn{
    width:auto;
    padding:10px 12px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--card);
    color: var(--text);
    box-shadow: none;
    font-weight:600;
    cursor:pointer;
  }

  .card{
    background: var(--card);
    padding:14px;
    border-radius: var(--radiusCard);
    margin-bottom:14px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }

  button, input{
    width:100%;
    box-sizing:border-box;
    padding:11px 12px;
    margin:8px 0;
    border-radius: var(--radiusBtn);
    border:1px solid var(--border);
    font-size:14px;
    background: transparent;
    color: var(--text);
  }

  button{
    background: var(--btn);
    color: var(--btnText);
    border:none;
    font-weight:700;
    cursor:pointer;
  }

  button:disabled{
    opacity:0.6;
    cursor:not-allowed;
  }

  .btn-row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }

  .btn-row button{
    width:auto;
    flex:1 1 160px;
    padding:11px 10px;
  }

  .danger{ background: var(--danger); color:#fff; }

  .soft{
    background: var(--btnSoftBg);
    color: var(--btnSoftText);
    border:1px solid var(--btnSoftBorder);
    font-weight:700;
  }

  .big{
    padding:14px 12px;
    font-size:16px;
    border-radius: var(--radiusCard);
  }

  .line{
    display:flex;
    justify-content:space-between;
    gap:10px;
    padding:10px 0;
    border-bottom:1px solid var(--line);
    font-size:14px;
    align-items:center;
  }
  .line:last-child{border-bottom:none;}

  .muted{color: var(--muted);}

  .mono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  .small{ font-size:13px; color: var(--muted); }

  /* Caja estado: estilo ‚Äúchip‚Äù */
  #estadoBox{
    margin-top:10px;
    padding:12px;
    border-radius: 14px;
    background: var(--chipBg);
    border: 1px solid var(--border);
  }
</style>
</head>
<body>

<div class="topbar">
  <div>
    <h1>Parking</h1>
    <div class="date-top" id="fechaHoy"></div>
  </div>

  <button class="theme-btn" id="btnTema" type="button" onclick="toggleTema()">
    üåô Modo oscuro
  </button>
</div>

<div class="card">
  <strong>Mi coche</strong>

  <button class="big" id="btnGuardar" onclick="guardarParking()">üìç Guardar d√≥nde aparqu√©</button>

  <div class="btn-row">
    <button id="btnAndando" class="soft" onclick="abrirRutaAndando()" disabled>üö∂ Ir andando al coche</button>
    <button id="btnVer" class="soft" onclick="verUbicacionCoche()" disabled>üìå Ver d√≥nde est√° mi coche</button>
  </div>

  <div id="estadoBox" class="small muted">
    Sin ubicaci√≥n guardada todav√≠a.
  </div>

  <div class="btn-row" style="margin-top:10px">
    <button id="btnCopiar" onclick="copiarCoords()" disabled>Copiar coordenadas</button>
    <button id="btnBorrar" class="danger" onclick="borrarParking()" disabled>Borrar ubicaci√≥n</button>
  </div>
</div>

<div class="card">
  <strong>Seguridad de datos</strong>
  <button onclick="hacerBackup()">Hacer copia de seguridad</button>
  <input type="file" id="restaurarInput" style="display:none" onchange="restaurarBackup(event)">
  <button onclick="document.getElementById('restaurarInput').click()">Restaurar copia</button>
  <div class="small muted" style="margin-top:8px;">
    La copia guarda solo esta app (ubicaci√≥n + fecha + precisi√≥n).
  </div>
</div>

<script>
const LS = { PARK: "park1_location", THEME: "park1_theme" };

document.getElementById("fechaHoy").textContent = new Date().toLocaleDateString("es-ES");
let park = null; // {lat, lon, acc, ts}

/* =========================
   ‚úÖ TEMA (solo visual)
   ========================= */
function applyTema(mode){
  const isDark = (mode === "dark");
  document.body.classList.toggle("dark", isDark);
  localStorage.setItem(LS.THEME, isDark ? "dark" : "light");

  const btn = document.getElementById("btnTema");
  if(btn){
    btn.textContent = isDark ? "‚òÄÔ∏è Modo claro" : "üåô Modo oscuro";
  }
}
function toggleTema(){
  const cur = localStorage.getItem(LS.THEME) || "light";
  applyTema(cur === "dark" ? "light" : "dark");
}

/* =========================
   APP (funcional igual que antes)
   ========================= */
function safeNum(n){
  const x = parseFloat(n);
  return isNaN(x) ? 0 : x;
}
function pad2(n){ return String(n).padStart(2,"0"); }
function formatDT(ts){
  const d = new Date(ts);
  return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function setEnabled(has){
  document.getElementById("btnAndando").disabled = !has;
  document.getElementById("btnVer").disabled = !has;
  document.getElementById("btnBorrar").disabled = !has;
  document.getElementById("btnCopiar").disabled = !has;
}

function render(){
  const box = document.getElementById("estadoBox");

  if(!park){
    box.innerHTML = "Sin ubicaci√≥n guardada todav√≠a.";
    setEnabled(false);
    return;
  }

  const acc = safeNum(park.acc);
  const when = park.ts ? formatDT(park.ts) : "‚Äî";

  box.innerHTML = `
    <div class="line"><span class="muted">Guardado</span><span><b>${when}</b></span></div>
    <div class="line"><span class="muted">Precisi√≥n</span><span>${acc ? (Math.round(acc) + " m") : "‚Äî"}</span></div>
    <div class="line"><span class="muted">Coords</span><span class="mono">${park.lat.toFixed(6)}, ${park.lon.toFixed(6)}</span></div>
  `;

  setEnabled(true);
}

function guardarParking(opts = {}){
  const { silent=false, overwrite=false } = opts;

  if(!navigator.geolocation){
    if(!silent) alert("Tu navegador no soporta GPS (geolocalizaci√≥n).");
    return;
  }

  // si ya hay una ubicaci√≥n y no quieres sobreescribir (modo rutina auto), salimos
  if(park && !overwrite){
    if(!silent) alert("Ya hay una ubicaci√≥n guardada. Si quieres cambiarla, pulsa Guardar.");
    return;
  }

  const btn = document.getElementById("btnGuardar");
  btn.disabled = true;
  btn.textContent = "Guardando ubicaci√≥n...";

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy;
      const ts = Date.now();

      park = {lat, lon, acc, ts};
      localStorage.setItem(LS.PARK, JSON.stringify(park));

      btn.disabled = false;
      btn.textContent = "üìç Guardar d√≥nde aparqu√©";

      try{ navigator.vibrate && navigator.vibrate(60); }catch(e){}

      render();
      if(!silent) alert("Ubicaci√≥n guardada ‚úÖ");
    },
    (err) => {
      btn.disabled = false;
      btn.textContent = "üìç Guardar d√≥nde aparqu√©";

      let msg = "No se pudo obtener la ubicaci√≥n.";
      if(err && err.code === 1) msg = "Permiso denegado. Activa la ubicaci√≥n para Chrome y vuelve a probar.";
      if(err && err.code === 2) msg = "Ubicaci√≥n no disponible. Prueba en un sitio con mejor cobertura GPS.";
      if(err && err.code === 3) msg = "Se agot√≥ el tiempo. Vuelve a intentar.";

      if(!silent) alert(msg);
    },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
  );
}

function abrirRutaAndando(){
  if(!park) return;
  const dest = `${park.lat},${park.lon}`;
  const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}&travelmode=walking`;
  window.location.href = `google.navigation:q=${park.lat},${park.lon}&mode=w`;
}

// üìå Ver pin del coche en Maps (sin ruta)
function verUbicacionCoche(){
  if(!park) return;
  const q = `${park.lat},${park.lon}`;
  const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
  window.location.href = `geo:${park.lat},${park.lon}?q=${park.lat},${park.lon}`;
}

async function copiarCoords(){
  if(!park) return;
  const txt = `${park.lat.toFixed(6)}, ${park.lon.toFixed(6)}`;
  try{
    await navigator.clipboard.writeText(txt);
    alert("Coordenadas copiadas ‚úÖ");
  }catch(e){
    const tmp = document.createElement("textarea");
    tmp.value = txt;
    document.body.appendChild(tmp);
    tmp.select();
    document.execCommand("copy");
    tmp.remove();
    alert("Coordenadas copiadas ‚úÖ");
  }
}

function borrarParking(){
  if(!park) return;
  if(!confirm("¬øBorrar la ubicaci√≥n guardada?")) return;

  park = null;
  localStorage.removeItem(LS.PARK);
  render();
  alert("Ubicaci√≥n borrada");
}

function hacerBackup(){
  const data = { park1_location: park };
  const blob = new Blob([JSON.stringify(data)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "parking_backup.json";
  a.click();
  URL.revokeObjectURL(url);
  alert("Copia de seguridad creada");
}

function restaurarBackup(event){
  const file = event.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(e){
    try{
      const data = JSON.parse(e.target.result);
      const p = data.park1_location;

      if(p && typeof p.lat === "number" && typeof p.lon === "number"){
        park = { lat: p.lat, lon: p.lon, acc: safeNum(p.acc), ts: p.ts || Date.now() };
        localStorage.setItem(LS.PARK, JSON.stringify(park));
        render();
        alert("Copia restaurada correctamente ‚úÖ");
      }else{
        alert("Archivo v√°lido, pero no contiene ubicaci√≥n.");
      }
    }catch(err){
      alert("Archivo no v√°lido");
    }finally{
      event.target.value = "";
    }
  };
  reader.readAsText(file);
}

function getParams(){
  const p = new URLSearchParams(window.location.search);
  return {
    auto: p.get("auto") === "1",
    go: p.get("go") === "1"
  };
}

(function init(){
  // ‚úÖ aplicar tema guardado (solo visual)
  applyTema(localStorage.getItem(LS.THEME) || "light");

  try{
    const saved = JSON.parse(localStorage.getItem(LS.PARK));
    if(saved && typeof saved.lat === "number" && typeof saved.lon === "number"){
      park = saved;
    }
  }catch(e){}

  render();

  // ‚úÖ par√°metros para tus rutinas Samsung
  const params = getParams();

  // auto=1 -> guarda SOLO si no hay ubicaci√≥n guardada (no pisa la anterior)
  if(params.auto){
    guardarParking({ silent:true, overwrite:true });
  }

  // go=1 -> abre Maps directo al pin del coche
  if(params.go){
    if(park) verUbicacionCoche();
    else alert("No hay ubicaci√≥n guardada todav√≠a.");
  }
})();
</script>

</body>
</html>
