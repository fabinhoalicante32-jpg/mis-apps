<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Parking</title>
<style>
  :root{
    --bg: #f3f4f6;
    --card: #ffffff;
    --text: #111827;
    --muted: #6b7280;
    --border: rgba(17,24,39,0.10);
    --shadow: 0 10px 24px rgba(0,0,0,0.06);

    --primary: #374151;       /* gris oscuro */
    --primaryText: #ffffff;

    --softBg: rgba(17,24,39,0.04);
    --softBorder: rgba(17,24,39,0.10);

    --danger: #b00020;

    --radiusCard: 18px;
    --radiusBtn: 14px;

    --line: rgba(17,24,39,0.08);
    --chip: rgba(17,24,39,0.05);
  }

  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    margin:0;
    padding:14px;
  }

  /* ===== Header tipo dashboard ===== */
  .header{
    background: linear-gradient(180deg, rgba(17,24,39,0.06), rgba(17,24,39,0.00));
    border: 1px solid var(--border);
    border-radius: var(--radiusCard);
    padding:14px 14px 12px 14px;
    box-shadow: var(--shadow);
    margin: 6px 0 14px 0;
  }
  .header-top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .title{
    font-size:22px;
    margin:0;
    letter-spacing:0.2px;
  }
  .date-top{
    font-size:13px;
    color: var(--muted);
    margin-top:4px;
  }
  .badge{
    font-size:12px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background: rgba(255,255,255,0.7);
    color: var(--text);
    white-space:nowrap;
    font-weight:600;
  }

  /* ===== Cards ===== */
  .card{
    background: var(--card);
    padding:14px;
    border-radius: var(--radiusCard);
    margin-bottom:14px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }

  .card-title{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .card-title strong{
    font-size:14px;
    letter-spacing:0.2px;
  }
  .hint{
    font-size:12px;
    color: var(--muted);
    background: var(--softBg);
    border:1px solid var(--softBorder);
    padding:6px 10px;
    border-radius:999px;
    white-space:nowrap;
  }

  /* ===== Inputs / Buttons ===== */
  button, input{
    width:100%;
    box-sizing:border-box;
    padding:12px 12px;
    margin:8px 0;
    border-radius: var(--radiusBtn);
    border:1px solid var(--border);
    font-size:14px;
    background: transparent;
    color: var(--text);
  }

  button{
    background: var(--primary);
    color: var(--primaryText);
    border:none;
    font-weight:800;
    cursor:pointer;
    letter-spacing:0.2px;
  }
  button:disabled{
    opacity:0.6;
    cursor:not-allowed;
  }

  .btn-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  @media (max-width: 420px){
    .btn-grid{ grid-template-columns: 1fr; }
  }

  .soft{
    background: var(--softBg);
    color: var(--text);
    border:1px solid var(--softBorder);
    font-weight:800;
  }

  .danger{
    background: var(--danger);
    color:#fff;
  }

  .big{
    padding:14px 12px;
    font-size:16px;
    border-radius: 16px;
  }

  /* ===== Estado (dashboard look) ===== */
  #estadoBox{
    margin-top:10px;
    padding:12px;
    border-radius: 16px;
    background: var(--chip);
    border: 1px solid var(--border);
  }

  .line{
    display:flex;
    justify-content:space-between;
    gap:10px;
    padding:10px 0;
    border-bottom:1px solid var(--line);
    font-size:14px;
    align-items:center;
  }
  .line:last-child{ border-bottom:none; }

  .muted{ color: var(--muted); }
  .mono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  .small{ font-size:13px; color: var(--muted); }

  /* mini separador */
  .divider{
    height:1px;
    background: var(--line);
    margin:12px 0 6px 0;
  }

  /* texto de ayuda */
  .note{
    margin-top:8px;
    font-size:12.5px;
    color: var(--muted);
    line-height:1.4;
  }
  #coordsLine {
  user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
  -webkit-touch-callout: none;
}
</style>
</head>
<body>

<!-- HEADER dashboard -->
<div class="header">
  <div class="header-top">
    <h1 class="title">Parking</h1>
    <div class="badge">GPS + Backup</div>
  </div>
  <div class="date-top" id="fechaHoy"></div>
</div>

<!-- CARD principal -->
<div class="card">
  <div class="card-title">
    <strong>Mi coche</strong>
    <span class="hint">Guarda ‚Ä¢ Ve ‚Ä¢ Navega</span>
  </div>

  <!-- ‚úÖ √öNICO CAMBIO: overwrite:true para que el bot√≥n SIEMPRE guarde aunque ya haya ubicaci√≥n -->
  <button class="big" id="btnGuardar" onclick="guardarParking({overwrite:true})">üìç Guardar d√≥nde aparqu√©</button>

  <div class="btn-grid">
    <button id="btnAndando" class="soft" onclick="abrirRutaAndando()" disabled>üö∂ Ir andando</button>
    <button id="btnVer" onclick="verUbicacionCoche()" disabled>üìå Ver en Maps</button>
  </div>

  <div id="estadoBox" class="small muted">
    Sin ubicaci√≥n guardada todav√≠a.
  </div>

  <!-- ‚úÖ NUEVO: distancia + direcci√≥n OFFLINE (usa solo GPS) -->
  <div class="btn-grid" style="margin-top:10px;">
    <button id="btnDist" class="soft" onclick="actualizarDistanciaOffline()" disabled>üì° Distancia offline</button>
    <button id="btnCopiar" class="soft" onclick="copiarCoords()" disabled>Copiar coords</button>
  </div>

  <div class="divider"></div>

  <div class="btn-grid" style="margin-top:6px;">
    <button id="btnBorrar" class="danger" onclick="borrarParking()" disabled>Borrar</button>
    <button id="btnDummy" class="soft" disabled style="opacity:0;pointer-events:none;">‚Äî</button>
  </div>
</div>

<!-- CARD seguridad -->
<div class="card">
  <div class="card-title">
    <strong>Seguridad de datos</strong>
    <span class="hint">Solo esta app</span>
  </div>

  <button onclick="hacerBackup()">Hacer copia de seguridad</button>
  <input type="file" id="restaurarInput" style="display:none" onchange="restaurarBackup(event)">
  <button class="soft" onclick="document.getElementById('restaurarInput').click()">Restaurar copia</button>

  <div class="note">
    La copia guarda √∫nicamente: ubicaci√≥n + fecha + precisi√≥n (no toca otras apps).
  </div>
</div>

<script>
const LS = { PARK: "park1_location" };

document.getElementById("fechaHoy").textContent = new Date().toLocaleDateString("es-ES");
let park = null; // {lat, lon, acc, ts}

function safeNum(n){
  const x = parseFloat(n);
  return isNaN(x) ? 0 : x;
}
function pad2(n){ return String(n).padStart(2,"0"); }
function formatDT(ts){
  const d = new Date(ts);
  return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

/* ‚úÖ NUEVO: utils distancia + rumbo */
function toRad(d){ return d * Math.PI / 180; }
function toDeg(r){ return r * 180 / Math.PI; }

function haversineMeters(lat1, lon1, lat2, lon2){
  const R = 6371000; // m
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function bearingDeg(lat1, lon1, lat2, lon2){
  const y = Math.sin(toRad(lon2-lon1)) * Math.cos(toRad(lat2));
  const x =
    Math.cos(toRad(lat1))*Math.sin(toRad(lat2)) -
    Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lon2-lon1));
  let brng = toDeg(Math.atan2(y, x));
  brng = (brng + 360) % 360;
  return brng;
}

function dir8(brng){
  const dirs = ["N","NE","E","SE","S","SO","O","NO"];
  const idx = Math.round(brng / 45) % 8;
  return dirs[idx];
}

function formatDist(m){
  if(!isFinite(m)) return "‚Äî";
  if(m < 1000) return `${Math.round(m)} m`;
  return `${(m/1000).toFixed(2)} km`;
}

function setEnabled(has){
  document.getElementById("btnAndando").disabled = !has;
  document.getElementById("btnVer").disabled = !has;
  document.getElementById("btnBorrar").disabled = !has;
  document.getElementById("btnCopiar").disabled = !has;
  document.getElementById("btnDist").disabled = !has;   // ‚úÖ NUEVO
}

function render(){
  const box = document.getElementById("estadoBox");

  if(!park){
    box.innerHTML = "Sin ubicaci√≥n guardada todav√≠a.";
    setEnabled(false);
    return;
  }

  const acc = safeNum(park.acc);
  const when = park.ts ? formatDT(park.ts) : "‚Äî";

  box.innerHTML = `
    <div class="line"><span class="muted">Guardado</span><span><b>${when}</b></span></div>
    <div class="line"><span class="muted">Precisi√≥n</span><span>${acc ? (Math.round(acc) + " m") : "‚Äî"}</span></div>
    <div class="line"><span class="muted">Coords</span><span class="mono" id="coordsLine">${park.lat.toFixed(6)}, ${park.lon.toFixed(6)}</span></div>

    <!-- ‚úÖ NUEVO: distancia offline -->
    <div class="line"><span class="muted">Distancia (offline)</span><span id="distOut">‚Äî</span></div>
    <div class="line"><span class="muted">Direcci√≥n</span><span id="dirOut">‚Äî</span></div>
    <div class="line"><span class="muted">Actualizado</span><span id="distWhen">‚Äî</span></div>
  `;

  setEnabled(true);
}

/* ‚úÖ NUEVO: calcula distancia + direcci√≥n usando GPS actual (funciona sin internet) */
function actualizarDistanciaOffline(opts = {}){
  const { silent=false } = opts;

  if(!park) return;
  if(!navigator.geolocation){
    if(!silent) alert("Tu navegador no soporta GPS (geolocalizaci√≥n).");
    return;
  }

  const btn = document.getElementById("btnDist");
  btn.disabled = true;
  const oldTxt = btn.textContent;
  btn.textContent = "Calculando...";

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      const m = haversineMeters(lat, lon, park.lat, park.lon);
      const brng = bearingDeg(lat, lon, park.lat, park.lon);
      const dir = dir8(brng);

      const distEl = document.getElementById("distOut");
      const dirEl = document.getElementById("dirOut");
      const whenEl = document.getElementById("distWhen");

      if(distEl) distEl.textContent = formatDist(m);
      if(dirEl) dirEl.textContent = `${dir} (${Math.round(brng)}¬∞)`;
      if(whenEl) whenEl.textContent = formatDT(Date.now());

      btn.disabled = false;
      btn.textContent = oldTxt;

      if(!silent){
        // alert("Distancia actualizada ‚úÖ");
      }
    },
    (err) => {
      btn.disabled = false;
      btn.textContent = oldTxt;

      let msg = "No se pudo obtener tu ubicaci√≥n actual.";
      if(err && err.code === 1) msg = "Permiso denegado. Activa la ubicaci√≥n para Chrome y vuelve a probar.";
      if(err && err.code === 2) msg = "Ubicaci√≥n no disponible. Prueba en un sitio con mejor cobertura GPS.";
      if(err && err.code === 3) msg = "Se agot√≥ el tiempo. Vuelve a intentar.";

      if(!silent) alert(msg);
    },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
  );
}

function guardarParking(opts = {}){
  const { silent=false, overwrite=false } = opts;

  if(!navigator.geolocation){
    if(!silent) alert("Tu navegador no soporta GPS (geolocalizaci√≥n).");
    return;
  }

  // si ya hay una ubicaci√≥n y no quieres sobreescribir (modo rutina auto), salimos
  if(park && !overwrite){
    if(!silent) alert("Ya hay una ubicaci√≥n guardada. Si quieres cambiarla, pulsa Guardar.");
    return;
  }

  const btn = document.getElementById("btnGuardar");
  btn.disabled = true;
  btn.textContent = "Guardando ubicaci√≥n...";

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy;
      const ts = Date.now();

      park = {lat, lon, acc, ts};
      localStorage.setItem(LS.PARK, JSON.stringify(park));

      btn.disabled = false;
      btn.textContent = "üìç Guardar d√≥nde aparqu√©";

      try{ navigator.vibrate && navigator.vibrate(60); }catch(e){}

      render();

      // ‚úÖ opcional: auto-calcular distancia al guardar
      actualizarDistanciaOffline({ silent:true });

      if(!silent) alert("Ubicaci√≥n guardada ‚úÖ");
    },
    (err) => {
      btn.disabled = false;
      btn.textContent = "üìç Guardar d√≥nde aparqu√©";

      let msg = "No se pudo obtener la ubicaci√≥n.";
      if(err && err.code === 1) msg = "Permiso denegado. Activa la ubicaci√≥n para Chrome y vuelve a probar.";
      if(err && err.code === 2) msg = "Ubicaci√≥n no disponible. Prueba en un sitio con mejor cobertura GPS.";
      if(err && err.code === 3) msg = "Se agot√≥ el tiempo. Vuelve a intentar.";

      if(!silent) alert(msg);
    },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
  );
}

function abrirRutaAndando(){
  if(!park) return;
  const dest = `${park.lat},${park.lon}`;
  const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}&travelmode=walking`;
  window.location.href = `google.navigation:q=${park.lat},${park.lon}&mode=w`;
}

// üìå Ver pin del coche en Maps (sin ruta)
function verUbicacionCoche(){
  if(!park) return;
  const q = `${park.lat},${park.lon}`;
  const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
  window.location.href = `geo:${park.lat},${park.lon}?q=${park.lat},${park.lon}`;
}

async function copiarCoords(){
  if(!park) return;
  const txt = `${park.lat.toFixed(6)}, ${park.lon.toFixed(6)}`;
  try{
    await navigator.clipboard.writeText(txt);
    alert("Coordenadas copiadas ‚úÖ");
  }catch(e){
    const tmp = document.createElement("textarea");
    tmp.value = txt;
    document.body.appendChild(tmp);
    tmp.select();
    document.execCommand("copy");
    tmp.remove();
    alert("Coordenadas copiadas ‚úÖ");
  }
}

function borrarParking(){
  if(!park) return;
  if(!confirm("¬øBorrar la ubicaci√≥n guardada?")) return;

  park = null;
  localStorage.removeItem(LS.PARK);
  render();
  alert("Ubicaci√≥n borrada");
}

function hacerBackup(){
  const data = { park1_location: park };
  const blob = new Blob([JSON.stringify(data)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "parking_backup.json";
  a.click();
  URL.revokeObjectURL(url);
  alert("Copia de seguridad creada");
}

function restaurarBackup(event){
  const file = event.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(e){
    try{
      const data = JSON.parse(e.target.result);
      const p = data.park1_location;

      if(p && typeof p.lat === "number" && typeof p.lon === "number"){
        park = { lat: p.lat, lon: p.lon, acc: safeNum(p.acc), ts: p.ts || Date.now() };
        localStorage.setItem(LS.PARK, JSON.stringify(park));
        render();

        // ‚úÖ opcional: auto-calcular distancia al restaurar
        actualizarDistanciaOffline({ silent:true });

        alert("Copia restaurada correctamente ‚úÖ");
      }else{
        alert("Archivo v√°lido, pero no contiene ubicaci√≥n.");
      }
    }catch(err){
      alert("Archivo no v√°lido");
    }finally{
      event.target.value = "";
    }
  };
  reader.readAsText(file);
}

function getParams(){
  const p = new URLSearchParams(window.location.search);
  return {
    auto: p.get("auto") === "1",
    go: p.get("go") === "1"
  };
}

(function init(){
  try{
    const saved = JSON.parse(localStorage.getItem(LS.PARK));
    if(saved && typeof saved.lat === "number" && typeof saved.lon === "number"){
      park = saved;
    }
  }catch(e){}

  render();

  // ‚úÖ par√°metros para tus rutinas Samsung
  const params = getParams();

  // auto=1 -> guarda SOLO si no hay ubicaci√≥n guardada (no pisa la anterior)
  if(params.auto){
    guardarParking({ silent:true, overwrite:true });
  }

  // go=1 -> abre Maps directo al pin del coche
  if(params.go){
    if(park) verUbicacionCoche();
    else alert("No hay ubicaci√≥n guardada todav√≠a.");
  }

  // ‚úÖ opcional: al abrir, si ya hay coche guardado, puedes calcular sin molestar
  if(park){
    actualizarDistanciaOffline({ silent:true });
  }
  // üîµ Ajuste manual con pulsaci√≥n larga (2 segundos)
let pressTimer;

document.addEventListener("touchstart", function(e){
  if(e.target && e.target.id === "coordsLine"){
    pressTimer = setTimeout(() => {
      ajusteManual();
    }, 1000);
  }
});

document.addEventListener("touchend", function(){
  clearTimeout(pressTimer);
});

document.addEventListener("mousedown", function(e){
  if(e.target && e.target.id === "coordsLine"){
    pressTimer = setTimeout(() => {
      ajusteManual();
    }, 1000);
  }
});

document.addEventListener("mouseup", function(){
  clearTimeout(pressTimer);
});

function ajusteManual(){
  if(!park) return;

  const raw = prompt(
    "Introduce nuevas coordenadas (lat,lon):",
    park.lat + "," + park.lon
  );

  if(raw === null) return;

  const parsed = parseCoordsFlexible(raw);
  if(!parsed){
    alert("Formato inv√°lido. Ejemplo v√°lido:\n38.3422124,-0.5060745\n√≥\n38,3422124, -0,5060745");
    return;
  }

  park = { lat: parsed.lat, lon: parsed.lon, acc: 0, ts: Date.now() };
  localStorage.setItem(LS.PARK, JSON.stringify(park));
  render();
  actualizarDistanciaOffline({ silent:true });
  alert("Ubicaci√≥n ajustada manualmente ‚úÖ");
}

function parseCoordsFlexible(input){
  let s = String(input || "").trim();

  const commas = (s.match(/,/g) || []).length;

  if(commas >= 3){
    s = s.replace(/,\s+/g, "|");
    s = s.replace(/,/g, ".");
    s = s.replace(/\|/g, ",");
  }

  const nums = s.match(/-?\d+(?:\.\d+)?/g);
  if(!nums || nums.length < 2) return null;

  const lat = parseFloat(nums[0]);
  const lon = parseFloat(nums[1]);

  if(!isFinite(lat) || !isFinite(lon)) return null;
  if(lat < -90 || lat > 90) return null;
  if(lon < -180 || lon > 180) return null;

  return { lat, lon };
}
})();
</script>

</body>
</html>
